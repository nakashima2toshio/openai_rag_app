# 医療QAデータ前処理アプリ 詳細設計書

## (1) 概要書

### プログラムの目的

医療QAデータセット（Question, Complex\_CoT, Response）を前処理し、Vector Store/RAGシステムに適した形式に変換するStreamlitアプリケーション。

### 概要

* **対象データ**: 医療質問回答データセット（CSVファイル）
* **処理内容**: テキストクレンジング、データ検証、列結合、前処理
* **出力形式**: 前処理済みCSV、結合テキスト（TXT）
* **UI**: Streamlit Webアプリケーション
* **主な機能**:
  * CSVファイルのアップロード
  * テキストの正規化・クレンジング
  * 3列（Question, Complex\_CoT, Response）の結合
  * 重複データの除去
  * データ検証とレポート
  * 前処理結果のダウンロード

---

## (2) main関数の処理の流れ

### 目的

Streamlitアプリケーションのメインエントリーポイントとして、UI構築とデータ処理ワークフローを制御する。

### 概要

1. **アプリケーション初期化**
   * Streamlitページ設定
   * タイトル・サイドバー設定
   * UI構築
2. **ファイル入力処理**
   * CSVファイルのアップロード
   * データ読み込み・検証
3. **前処理実行**
   * テキストクレンジング
   * データ検証
   * 列結合（オプション）
   * 統計情報表示
4. **結果出力**
   * 前処理済みデータのダウンロード
   * 使用方法の説明表示

### 処理フロー

```
開始
↓
Streamlitアプリ初期化
↓
CSVファイルアップロード待機
↓
ファイル読み込み・検証
↓
前処理実行ボタン押下
↓
各種前処理関数実行
↓
結果表示・ダウンロード提供
↓
終了
```

---

## (3) 各関数の仕様

### (3-1) 関数一覧表


| 関数名                     | 概要                                                 |
| -------------------------- | ---------------------------------------------------- |
| `clean_text`               | テキストのクレンジング処理（改行除去、空白正規化等） |
| `combine_columns`          | 3列を結合して1つのテキストにする（Vector Store用）   |
| `additional_preprocessing` | その他の前処理（重複除去、空行除去等）               |
| `validate_data`            | データの検証（必須列確認、空値チェック等）           |
| `main`                     | メイン処理（Streamlitアプリケーション制御）          |

### (3-2) 各関数の仕様

#### 関数名: `clean_text`

* **処理概要**: 入力テキストに対してクレンジング処理を実行し、Vector Store/RAGシステムに適した形式に正規化する
* **IPO**:
  * **INPUT**: `text: str` - 処理対象のテキスト
  * **PROCESS**:
    * 空値・NaN値チェック
    * 改行文字の空白置換
    * 連続空白の統一
    * 先頭・末尾空白の除去
    * 引用符の正規化
  * **OUTPUT**: `str` - クレンジング済みテキスト

#### 関数名: `combine_columns`

* **処理概要**: DataFrameの1行から3列（Question, Complex\_CoT, Response）を取得し、Vector Store用に最適化された1つのテキストに結合する
* **IPO**:
  * **INPUT**: `row: pd.Series` - DataFrameの1行データ
  * **PROCESS**:
    * 各列からテキスト抽出
    * 各テキストのクレンジング
    * 自然な文章として結合
  * **OUTPUT**: `str` - 結合済みテキスト

#### 関数名: `additional_preprocessing`

* **処理概要**: データフレーム全体に対する基本的な前処理を実行し、データ品質を向上させる
* **IPO**:
  * **INPUT**: `df: pd.DataFrame` - 前処理対象のDataFrame
  * **PROCESS**:
    * 重複行の除去
    * 必須列の空行除去
    * インデックスのリセット
  * **OUTPUT**: `pd.DataFrame` - 前処理済みDataFrame

#### 関数名: `validate_data`

* **処理概要**: データフレームの品質を検証し、問題点や統計情報をレポートとして生成する
* **IPO**:
  * **INPUT**: `df: pd.DataFrame` - 検証対象のDataFrame
  * **PROCESS**:
    * 必須列の存在確認
    * 空値の数量チェック
    * 各列の平均文字数計算
    * 問題点の特定
  * **OUTPUT**: `List[str]` - 検証結果・問題点のリスト

#### 関数名: `main`

* **処理概要**: Streamlitアプリケーションのメイン制御処理。UI構築、ファイル処理、前処理実行、結果表示を統括する
* **IPO**:
  * **INPUT**:
    * Streamlitセッション状態
    * ユーザーアップロードファイル
    * UI操作（ボタン押下等）
  * **PROCESS**:
    * Streamlitページ設定
    * ファイルアップロード処理
    * データ読み込み・検証
    * 各前処理関数の実行
    * 結果の表示・統計情報生成
    * ダウンロード機能提供
  * **OUTPUT**:
    * Streamlit UI画面
    * 前処理済みCSVファイル
    * 結合テキストファイル（TXT）

---

## 不足情報・改善提案

### 現在の実装で不足している情報

1. **エラーハンドリング**: 各関数に適切な例外処理が不足
2. **ログ出力**: 処理状況の記録機能が未実装
3. **設定値**: 処理パラメータがハードコーディングされている
4. **テストケース**: 単体テスト・統合テストが未定義
5. **パフォーマンス**: 大量データ処理時の最適化が未考慮

### 推奨される追加実装

1. **エラーハンドリング機能の強化**
2. **設定ファイル（config.yml）の活用**
3. **ログ機能の実装**
4. **プログレスバーの追加**
5. **データ形式バリデーションの強化**
6. **メモリ使用量の監視**

---

## 依存関係・前提条件

### 必須ライブラリ

* streamlit
* pandas
* re (標準ライブラリ)
* io (標準ライブラリ)
* typing (標準ライブラリ)

### 入力データ要件

* CSVファイル形式
* 必須列: Question, Complex\_CoT, Response
* 文字エンコーディング: UTF-8推奨

### 出力データ仕様

* 前処理済みCSV: UTF-8エンコーディング
* 結合テキスト: プレーンテキスト形式
* ファイル名: タイムスタンプ付き自動生成
