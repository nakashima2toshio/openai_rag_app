# a30_014_make_rag_data_sciq.py 設計書

## 1. 概要書

### 1.1 処理の概要

科学・技術QA（SciQ）データのCSVファイルを読み込み、RAG（Retrieval-Augmented Generation）用に最適化された前処理を行うStreamlitアプリケーション。helper_rag.pyの共通機能を活用し、科学・技術分野特有のデータ分析・検証機能を追加したWebアプリケーション。

**主要機能:**

- 科学・技術QAデータのCSVファイル処理
- 多肢選択問題（distractor列）対応
- 補足説明（support列）処理
- 科学・技術用語の専門分析
- 選択肢形式vs記述形式の回答分析
- OpenAIモデル選択とトークン使用量推定
- 処理済みデータのダウンロード・保存

**対応データ構造:**

- 必須列: question, correct_answer
- オプション列: distractor1, distractor2, distractor3, support
- 科学分野: 化学、物理、生物、数学、地理、天文、医学、工学

### 1.2 mainの処理の流れ

初期設定・ページ構築
├─ データセットタイプ設定（sciq_qa）
├─ setup_page_config() - ページ設定
├─ setup_page_header() - ヘッダー設定
└─ setup_sidebar_header() - サイドバー設定

サイドバー構築
├─ select_model() - OpenAIモデル選択UI
├─ show_model_info() - モデル情報表示
├─ 前処理設定UI（結合オプション、検証表示）
└─ SciQ特有設定UI
├─ include_distractors - 選択肢含める設定
├─ include_support - 補足説明含める設定
└─ preserve_scientific_notation - 科学的記法保護

メインエリア構築
├─ 選択モデル情報表示
└─ ファイルアップロードUI

ファイル処理フロー
├─ ファイル存在判定
├─ セッション状態管理
├─ load_dataset() - ファイル読み込み・基本検証
├─ データプレビュー表示
├─ データ構造情報表示（カラム一覧・データ型）
└─ データ検証結果表示
├─ validate_data() - 基本検証（共通機能）
└─ validate_sciq_data_specific() - SciQ特有検証

前処理実行フロー
├─ 処理ボタン押下判定
├─ process_rag_data() - RAG前処理実行
├─ display_statistics() - 統計情報表示
├─ estimate_token_usage() - トークン使用量推定
└─ SciQ特有分析
├─ 科学・技術用語出現頻度分析
├─ 質問の複雑度分析
├─ 多肢選択問題分析
└─ 補足説明分析

出力処理フロー
├─ create_download_data() - ダウンロード用データ作成
├─ ブラウザダウンロード機能
└─ save_files_to_output() - ローカル保存

補助機能
├─ show_usage_instructions() - 使用方法説明
├─ サンプルデータ表示（科学問題例）
└─ デバッグ情報表示


エラーハンドリング
├─ 各段階での例外処理
├─ エラー詳細表示
└─ ファイル診断情報表示

## 2. 関数一覧

### 2.1 アプリケーション固有関数


| 関数名                          | 処理概要                                   |
| ------------------------------- | ------------------------------------------ |
| `validate_sciq_data_specific()` | SciQ（科学・技術QA）特有のデータ検証・分析 |
| `main()`                        | Streamlitアプリケーションのメイン処理統括  |

### 2.2 helper_rag.py インポート関数


| 関数名                      | 処理概要                      |
| --------------------------- | ----------------------------- |
| `setup_page_config()`       | Streamlitページ設定初期化     |
| `setup_page_header()`       | ページヘッダー設定            |
| `setup_sidebar_header()`    | サイドバーヘッダー設定        |
| `select_model()`            | OpenAIモデル選択UI            |
| `show_model_info()`         | 選択モデル詳細情報表示        |
| `load_dataset()`            | CSVファイル読み込み・基本検証 |
| `validate_data()`           | 汎用データ品質検証            |
| `process_rag_data()`        | RAG用データ前処理実行         |
| `display_statistics()`      | 処理前後統計情報表示          |
| `estimate_token_usage()`    | トークン使用量推定表示        |
| `create_download_data()`    | ダウンロード用データ作成      |
| `save_files_to_output()`    | OUTPUTフォルダへの保存        |
| `show_usage_instructions()` | 使用方法説明表示              |

### 2.3 設定・管理クラス（インポート）


| クラス名       | 処理概要                         |
| -------------- | -------------------------------- |
| `AppConfig`    | OpenAIモデル設定・料金・制限管理 |
| `RAGConfig`    | データセット設定管理             |
| `TokenManager` | トークン数・コスト計算管理       |

## 3. 関数の詳細設計書

### 3.1 validate_sciq_data_specific()

**処理概要:**
・SciQ（科学・技術QA）データに特化した品質検証・分析を実行し、科学用語分析、回答形式分析、多肢選択問題分析、補足説明分析を行う。

**処理の流れ:**

科学・技術関連用語の存在確認
├─ 科学分野キーワードリスト定義
│   ├─ 日本語: '化学', '物理', '生物', '数学', '地理', '天文', '医学', '工学'
│   └─ 英語: 'chemistry', 'physics', 'biology', 'math', 'geography', 'astronomy', 'medicine', 'engineering', 'science', 'theory', 'experiment', 'formula'
├─ question列の大文字小文字対応検索
├─ 各行での科学用語検索
├─ 該当件数カウント・比率計算
└─ 結果記録

回答の種類分析（選択肢形式vs記述形式）
├─ correct_answer/answer列の検索
├─ 各回答の文字数計算
├─ 短い回答（≤50文字）と長い回答（>50文字）分類
├─ 平均回答長計算
└─ 回答形式統計記録

多肢選択問題の分析
├─ distractor列の検索・特定
├─ 各distractor列のデータ存在確認
├─ 選択肢数カウント
├─ 各列の非空データ件数集計
└─ 多肢選択形式情報記録

補足説明の分析
├─ support列の検索・特定
├─ 補足説明データ存在確認
├─ 補足説明含有率計算
├─ 平均補足説明長計算
└─ 補足説明統計記録


分析結果リスト生成・返却

**IPO:**

- **INPUT:** `df` (pandas.DataFrame) - SciQ（科学・技術QA）データフレーム
- **PROCESS:**
  - 科学用語分析（化学、物理、生物、数学等の専門用語）
  - 回答形式分析（50文字閾値での選択肢形式判定）
  - 多肢選択問題分析（distractor1-3列の存在・利用状況）
  - 補足説明分析（support列の存在・利用状況）
  - 大文字小文字対応の柔軟な列名検索
- **OUTPUT:** `List[str]` - SciQ特有分析結果メッセージリスト

### 3.2 main()

**処理概要:**
SciQ（科学・技術QA）データ処理に特化したStreamlitアプリケーション全体の統括制御を行い、科学分野特有のUI構築、データ処理、分析表示を管理する。

**処理の流れ:**

初期設定・ページ構築
├─ DATASET_TYPE = "sciq_qa" 設定
├─ setup_page_config(DATASET_TYPE) 呼び出し
├─ setup_page_header(DATASET_TYPE) 呼び出し
└─ setup_sidebar_header(DATASET_TYPE) 呼び出し

サイドバーUI構築
├─ select_model(key="sciq_model_selection") 呼び出し
├─ show_model_info(selected_model) 呼び出し
├─ 前処理設定UI作成
│   ├─ combine_columns_option チェックボックス
│   └─ show_validation チェックボックス
└─ SciQ特有設定UI作成
├─ include_distractors - 選択肢含める設定
├─ include_support - 補足説明含める設定
└─ preserve_scientific_notation - 科学的記法保護

メインエリアUI構築
├─ 選択モデル情報表示
└─ st.file_uploader() による科学QAファイルアップロード

ファイル処理制御
├─ アップロードファイル存在判定
├─ ファイル情報表示
├─ セッション状態による重複処理防止
├─ load_dataset() による読み込み・基本検証
├─ セッション状態への保存
├─ データプレビュー表示
└─ データ構造情報表示（カラム一覧・データ型）

データ検証・分析表示
├─ show_validation フラグ判定
├─ 基本検証結果表示（共通機能）
└─ validate_sciq_data_specific() 実行・表示

前処理実行制御
├─ 処理ボタン押下判定
├─ process_rag_data() による前処理実行
├─ セッション状態への処理済みデータ保存
├─ display_statistics() による統計表示
├─ estimate_token_usage() による推定表示
└─ SciQ特有分析
├─ 科学・技術用語出現頻度分析
├─ 質問の複雑度分析
├─ 多肢選択問題詳細分析
│   ├─ 選択肢数統計
│   ├─ 最大選択肢数
│   └─ 選択肢利用率計算
└─ 補足説明詳細分析
├─ 平均説明長
├─ 最大説明長
└─ 説明含有率

出力処理制御
├─ 処理済みデータ存在確認
├─ create_download_data() によるダウンロード用データ作成
├─ ブラウザダウンロードボタン提供
│   ├─ CSV形式ダウンロード
│   └─ テキスト形式ダウンロード（sciq_qa.txt）
└─ save_files_to_output() によるローカル保存

補助機能制御
├─ ファイル未選択時のサンプル表示（科学問題例）
├─ show_usage_instructions() による使用方法説明
└─ デバッグ情報表示（条件付き）


エラーハンドリング
├─ 各処理段階での try-except
├─ エラー詳細情報表示
├─ ファイル診断情報表示
└─ ログ出力

**IPO:**

- **INPUT:**
  - Streamlit UI入力（科学QAファイルアップロード、SciQ特有設定）
  - セッション状態データ
  - 環境設定
- **PROCESS:**
  - 科学・技術QA特有のUI制御・レンダリング
  - 多肢選択問題対応のファイル処理
  - 科学用語・選択肢・補足説明の専門分析
  - セッション状態管理
  - SciQ特有エラーハンドリング
- **OUTPUT:**
  - 科学・技術QA特化のStreamlit UI表示・更新
  - 処理済みsciq_qa.txtファイル出力
  - 科学分野特有の分析結果表示
  - セッション状態更新
  - ログ出力

## 4. 不足情報の指摘

### 4.1 科学・技術データ特有仕様の不足

1. **科学分野カバレッジ詳細**

   - 対応する科学分野の詳細範囲
   - 各分野の専門用語辞書の完全性
   - 新しい科学分野への拡張仕様
   - 分野別の重み付け・優先度
2. **多肢選択問題仕様**

   - distractor列の最大数制限
   - 選択肢の品質評価基準
   - 正解選択肢と不正解選択肢の妥当性チェック
   - 選択肢の重複検出・除去
3. **科学的記法保護仕様**

   - preserve_scientific_notation の具体的保護対象
   - 数式・化学式・物理式の保護ルール
   - LaTeX記法・MathML対応の有無
   - 科学記号の正規化ルール

### 4.2 データ品質管理仕様の不足

1. **科学内容の妥当性検証**

   - 科学的事実の正確性チェック機能
   - 古い科学情報の検出・更新
   - 分野別専門家レビューの要否
   - 科学的誤情報の検出機能
2. **問題難易度分析**

   - 質問の難易度レベル判定
   - 対象学年・教育レベルの分類
   - 基礎・応用・発展レベルの自動判定
   - 難易度バランスの評価

### 4.3 補足説明（support）処理仕様の不足

1. **support列の活用詳細**

   - include_support設定の具体的処理方法
   - 補足説明と本文の結合ルール
   - 補足説明の品質評価基準
   - 冗長な説明の検出・整理
2. **背景知識管理**

   - 前提知識の依存関係管理
   - 概念間の関連性マッピング
   - 学習順序の考慮
   - 知識グラフ構築への対応

### 4.4 多言語・国際化仕様の不足

1. **科学用語の多言語対応**

   - 英語以外の科学用語対応
   - 国際単位系（SI）の統一
   - 地域別科学教育カリキュラム対応
   - 専門用語の翻訳品質管理
2. **数値・単位の標準化**

   - 単位系の統一（メートル法、ヤード・ポンド法）
   - 有効数字の扱い
   - 科学記数法の正規化
   - 測定誤差・不確かさの表記

### 4.5 パフォーマンス・スケーラビリティ仕様の不足

1. **大規模データ処理**

   - 数万問規模のSciQデータ処理性能
   - メモリ効率的な科学用語検索
   - 分析処理の並列化対応
   - 段階的処理による応答性向上
2. **キャッシュ・最適化**

   - 科学用語辞書のキャッシュ機能
   - 分析結果の再利用機構
   - インクリメンタル処理対応
   - バッチ処理モードの提供

### 4.6 教育・学習支援仕様の不足

1. **教育用途への最適化**

   - 教育課程別の問題分類
   - 学習目標との対応付け
   - アダプティブラーニング対応
   - 学習進捗追跡機能
2. **問題品質評価**

   - 問題の教育的価値評価
   - 類似問題の検出・統合
   - 問題の更新・改訂履歴管理
   - 利用統計・効果測定
