# OpenAI API ヘルパーライブラリ詳細設計書（改修版）

## 概要書

### 処理の概要
本プログラムは、OpenAI APIの利用を簡素化するためのヘルパーライブラリです。設定管理、キャッシュ機能、メッセージ履歴管理、トークン数管理、APIレスポンス処理、クライアント管理などの機能を提供します。

**主要機能：**
1. **設定管理**：YAML設定ファイルと環境変数による包括的な設定管理（シングルトンパターン）
2. **キャッシュ機能**：多層キャッシュシステムによるAPI効率化
3. **メッセージ管理**：チャット履歴の管理とカスタマイズ可能なデフォルトプロンプト提供
4. **トークン管理**：最新モデル対応のトークン数計算、詳細なコスト推定、テキスト切り詰め
5. **レスポンス処理**：APIレスポンスの整形、保存、多形式テキスト抽出
6. **APIクライアント**：OpenAI Responses APIとChat Completions APIの統合ラッパー
7. **ユーティリティ**：JSON処理、ログ管理、多言語対応、デコレータ機能

### 設定ファイル構造（config.yaml）
**主要セクション：**
- **app**: アプリケーション基本情報
- **models**: 18モデル対応（GPT-4o系、o1-o4系、カテゴリ別分類）
- **model_pricing**: 詳細な料金設定（入力・出力別）
- **api**: API接続設定、リトライ、制限設定
- **ui**: Streamlit UI設定、テーマ、フォーム設定
- **default_messages**: 開発者向けプロンプトテンプレート
- **error_messages**: 多言語（日本語・英語）エラーメッセージ
- **samples**: デモ用サンプルデータ
- **paths**: ファイルパス管理
- **logging**: 詳細なログ設定
- **cache**: 多層キャッシュ設定
- **experimental**: ベータ機能管理
- **security**: セキュリティ設定
- **i18n**: 国際化設定

### mainの処理の流れ
**注意：本ライブラリにはmain関数は存在しません。**
これはインポートして使用するライブラリとして設計されています。

**典型的な使用フロー：**
1. ライブラリのインポート
2. 設定の自動初期化（ConfigManager）→ config.yaml読み込み
3. 多言語対応・エラーメッセージ初期化
4. OpenAIClientインスタンス作成（APIキー自動取得）
5. MessageManagerでプロンプト管理
6. TokenManagerでコスト事前計算
7. API呼び出し実行（エラーハンドリング・リトライ付き）
8. ResponseProcessorでレスポンス処理・保存

---

## クラス・関数一覧

### クラス一覧

| クラス名 | 処理概要 |
|----------|----------|
| `ConfigManager` | シングルトンパターンによる包括的設定管理。18項目の設定セクション、環境変数オーバーライド、多言語ログ設定 |
| `MemoryCache` | 多層キャッシュシステム。API/モデル/ユーザー設定別TTL、サイズ制限付きキャッシュ管理 |
| `MessageManager` | 多言語対応メッセージ履歴管理。カスタムプロンプトテンプレート、履歴制限、インポート/エクスポート機能 |
| `TokenManager` | 18モデル対応トークン管理。詳細コスト計算（入力・出力別料金）、モデル制限情報、テキスト切り詰め |
| `ResponseProcessor` | APIレスポンス統合処理。多形式テキスト抽出、JSON整形、ログディレクトリ自動作成、保存機能 |
| `OpenAIClient` | OpenAI API統合クライアント。Responses/Chat Completions API、エラーハンドリング、リトライ機能 |

### 関数一覧

| 関数名 | 処理概要 |
|--------|----------|
| `safe_json_serializer()` | カスタムJSONシリアライザー。OpenAI APIオブジェクト、Pydantic、datetime対応 |
| `safe_json_dumps()` | 安全なJSON文字列化。フォールバック機能、エラー耐性 |
| `get_default_messages()` | 設定ファイルベースのデフォルトメッセージセット取得 |
| `append_user_message()` | ユーザーメッセージ追加（画像URL対応） |
| `append_developer_message()` | 開発者メッセージ追加 |
| `append_assistant_message()` | アシスタントメッセージ追加 |
| `sanitize_key()` | キー文字列の安全化（英数字とアンダースコアのみ） |
| `load_json_file()` | JSONファイルの読み込み（例外処理、ログ出力付き） |
| `save_json_file()` | JSONファイルの保存（ディレクトリ自動作成、例外処理付き） |
| `format_timestamp()` | タイムスタンプのフォーマット変換（複数形式対応） |
| `create_session_id()` | ユニークなセッションID生成（8文字ハッシュ） |

### デコレータ一覧

| デコレータ名 | 処理概要 |
|------------|----------|
| `@error_handler` | エラーハンドリングデコレータ。多言語エラーメッセージ、ログ出力、例外再発生 |
| `@timer` | 実行時間計測デコレータ。パフォーマンス監視、ログ出力 |
| `@cache_result(ttl)` | 結果キャッシュデコレータ。ハッシュキー生成、TTL設定可能 |

---

## クラスの詳細設計書

### 1. ConfigManager

#### 処理概要
シングルトンパターンで実装された包括的設定管理クラス。18の設定セクションを持つYAML設定ファイル（config.yaml）の読み込み、環境変数による設定オーバーライド、多言語対応ログシステムの初期化を行います。

#### 設定セクション詳細
1. **app**: アプリケーション基本情報（名前、バージョン、作者）
2. **models**: 18モデル定義（GPT-4o系、o1-o4系、カテゴリ別分類）
3. **model_pricing**: 詳細料金設定（入力・出力別、1000トークンあたりUSD）
4. **api**: API設定（タイムアウト、リトライ、メッセージ制限）
5. **ui**: Streamlit UI設定（テーマ、レイアウト、フォーム）
6. **default_messages**: 開発者向けプロンプトテンプレート
7. **error_messages**: 多言語エラーメッセージ（日本語・英語）
8. **samples**: デモ用サンプルデータ（画像、プロンプト、ドキュメント）
9. **paths**: ファイルパス管理（データ、ログ、キャッシュ等）
10. **logging**: 詳細ログ設定（レベル、フォーマット、ローテーション）
11. **cache**: 多層キャッシュ設定（タイプ別TTL）
12. **experimental**: ベータ機能管理
13. **security**: セキュリティ設定（APIキー管理、レート制限）
14. **i18n**: 国際化設定
15. **integrations**: 外部API統合設定
16. **development**: 開発者設定
17. **demos**: デモ設定
18. **その他**: バックアップ、通知、ヘルスチェック

#### 処理の流れ
1. シングルトンインスタンス確認・作成
2. config.yaml設定ファイルの読み込み（18セクション）
3. 環境変数オーバーライド適用（OPENAI_API_KEY, LOG_LEVEL, DEBUG_MODE）
4. デフォルト設定のフォールバック（全18セクション対応）
5. 多言語ログシステムの設定・初期化
6. 設定値キャッシュシステムの準備

#### IPO（INPUT、PROCESS、OUTPUT）
- **INPUT：**
  - config.yaml設定ファイル（18セクション構造）
  - 環境変数（OPENAI_API_KEY, LOG_LEVEL, DEBUG_MODE）

- **PROCESS：**
  - YAML設定ファイル解析（18セクション）
  - 環境変数オーバーライド処理
  - 多言語ログハンドラー設定（コンソール・ファイル・ローテーション）
  - 設定値キャッシュ管理（ドット記法対応）
  - シングルトンパターン制御

- **OUTPUT：**
  - 18セクション設定値の提供（get/setメソッド）
  - 多言語対応ログシステム
  - 設定保存・再読み込み機能

---

### 2. MemoryCache

#### 処理概要
多層キャッシュシステム。API応答、モデル情報、ユーザー設定別にTTL（Time To Live）を設定し、メモリベースキャッシュによるAPI効率化とサイズ制限によるメモリ管理を行います。

#### キャッシュタイプ別設定
- **api_responses**: TTL 30分、最大50エントリ
- **model_info**: TTL 24時間、最大20エントリ
- **user_preferences**: TTL 1週間、最大30エントリ
- **一般キャッシュ**: TTL 1時間、最大100エントリ

#### 処理の流れ
1. キャッシュ設定の初期化（有効/無効、タイプ別TTL、最大サイズ）
2. キャッシュ取得時のTTL検証（タイプ別）
3. 期限切れデータの自動削除
4. サイズ制限チェックと古いデータの削除（LRU方式）
5. キャッシュデータの保存・管理

#### IPO（INPUT、PROCESS、OUTPUT）
- **INPUT：**
  - キャッシュキー（文字列）
  - キャッシュ値（Any型）
  - キャッシュタイプ（api_responses/model_info/user_preferences）
  - 設定値（タイプ別TTL、最大サイズ、有効フラグ）

- **PROCESS：**
  - タイプ別TTL検証・期限切れ削除
  - LRU（Least Recently Used）によるサイズ管理
  - タイムスタンプ管理
  - メモリ使用量制御

- **OUTPUT：**
  - キャッシュされた値（有効期限内の場合）
  - None（キャッシュなし・期限切れの場合）
  - キャッシュサイズ・統計情報

---

### 3. MessageManager

#### 処理概要
多言語対応のチャット形式メッセージ履歴管理クラス。設定ファイルベースのカスタマイズ可能なデフォルトプロンプト提供、メッセージ数制限、インポート/エクスポート機能を提供します。

#### デフォルトメッセージテンプレート（config.yaml）
- **developer**: ソフトウェア開発専門家向けプロンプト（日英バイリンガル）
- **user**: 問題特定・解決手順指示プロンプト（日英バイリンガル）
- **assistant**: OpenAI API使用案内（日本語）

#### 処理の流れ
1. 設定ファイルからデフォルトメッセージテンプレート読み込み
2. メッセージ追加時のロール検証（user/assistant/system/developer）
3. メッセージ数制限の適用（設定可能、デフォルト50件）
4. 開発者メッセージ保護（制限時も最初の開発者メッセージは保持）
5. 履歴のエクスポート/インポート処理（タイムスタンプ付き）

#### IPO（INPUT、PROCESS、OUTPUT）
- **INPUT：**
  - ロール（user/assistant/system/developer）
  - メッセージ内容（文字列）
  - インポートデータ（辞書形式、タイムスタンプ付き）
  - 設定ファイルのデフォルトメッセージ

- **PROCESS：**
  - ロール妥当性検証
  - メッセージ数制限適用（設定可能）
  - 開発者メッセージ保護
  - タイムスタンプ管理

- **OUTPUT：**
  - メッセージ履歴（EasyInputMessageParamリスト）
  - エクスポートデータ（辞書形式、タイムスタンプ付き）
  - カスタマイズ可能なデフォルトメッセージセット

---

### 4. TokenManager

#### 処理概要
18の最新GPTモデルに対応したトークン数計算、詳細なコスト推定、テキスト切り詰め機能を提供するクラス。設定ファイルの料金データを使用して精密なコスト計算を行います。

#### 対応モデル・料金（1000トークンあたりUSD）
**GPT-4o系:**
- gpt-4o: 入力$0.005, 出力$0.015
- gpt-4o-mini: 入力$0.00015, 出力$0.0006
- gpt-4o-audio-preview: 入力$0.01, 出力$0.02
- gpt-4o-mini-audio-preview: 入力$0.00025, 出力$0.001

**GPT-4.1系:**
- gpt-4.1: 入力$0.0025, 出力$0.01
- gpt-4.1-mini: 入力$0.0001, 出力$0.0004

**o1-o4系（推論モデル）:**
- o1: 入力$0.015, 出力$0.06
- o1-mini: 入力$0.003, 出力$0.012
- o3: 入力$0.03, 出力$0.12
- o3-mini: 入力$0.006, 出力$0.024
- o4: 入力$0.05, 出力$0.20
- o4-mini: 入力$0.01, 出力$0.04

#### 処理の流れ
1. モデル別エンコーディング方式の特定（cl100k_base統一）
2. tiktokenライブラリによる正確なトークン数計算
3. 指定トークン数でのテキスト切り詰め（エンコーディング考慮）
4. 設定ファイルの料金データを使用した詳細コスト推定
5. モデル制限情報の提供（最大トークン・最大出力）

#### IPO（INPUT、PROCESS、OUTPUT）
- **INPUT：**
  - テキスト（文字列）
  - モデル名（18モデル対応）
  - 最大トークン数
  - 入力/出力トークン数（コスト計算用）
  - 設定ファイルの料金データ

- **PROCESS：**
  - tiktokenエンコーディング処理（cl100k_base）
  - 正確なトークン数カウント
  - エンコーディング考慮のテキスト切り詰め
  - 詳細コスト計算（入力・出力・合計）

- **OUTPUT：**
  - 正確なトークン数（整数）
  - 切り詰めテキスト
  - 詳細推定コスト（USD、入力・出力別）
  - モデル制限情報（最大トークン・最大出力）

---

### 5. ResponseProcessor

#### 処理概要
OpenAI APIのレスポンスオブジェクトを統合処理し、多形式テキスト抽出、安全な整形、ログディレクトリ自動作成付きJSON保存機能を提供するクラス。

#### 処理の流れ
1. レスポンスオブジェクトからの多形式テキスト抽出
2. ResponseUsageオブジェクトの安全な辞書変換（Pydantic対応）
3. レスポンス全体の整形（JSON serializable形式）
4. 設定ファイルのログディレクトリ自動作成
5. タイムスタンプ付きファイル保存

#### IPO（INPUT、PROCESS、OUTPUT）
- **INPUT：**
  - OpenAI Responseオブジェクト
  - 保存ファイル名（オプション）
  - 設定ファイルのパス情報

- **PROCESS：**
  - レスポンス構造解析（output属性解析）
  - 多形式テキストコンテンツ抽出
  - usage情報の安全なシリアライズ
  - 安全なJSON変換（safe_json_dumps使用）
  - ファイルシステム操作（ディレクトリ自動作成）

- **OUTPUT：**
  - 抽出テキスト（リスト）
  - 整形レスポンス（辞書、JSON serializable）
  - 保存ファイルパス（ログディレクトリ内）

---

### 6. OpenAIClient

#### 処理概要
OpenAI APIへの統一インターフェースを提供する統合クライアントクラス。Responses APIとChat Completions APIの両方をサポートし、設定ファイルベースのエラーハンドリング、リトライ機能を提供します。

#### 処理の流れ
1. APIキーの検証・取得（設定ファイル・環境変数の優先順位）
2. OpenAIクライアントの初期化（タイムアウト・リトライ設定適用）
3. API呼び出しパラメータの準備・検証
4. 多言語エラーハンドリング付きAPI呼び出し
5. 実行時間の計測・ログ出力

#### IPO（INPUT、PROCESS、OUTPUT）
- **INPUT：**
  - APIキー（設定ファイル・環境変数）
  - メッセージ（旧：messages, 新：input）
  - モデル名（18モデル対応）
  - 追加パラメータ（kwargs）
  - 設定ファイルのAPI設定

- **PROCESS：**
  - APIキー検証（多言語エラー対応）
  - OpenAIライブラリ呼び出し（タイムアウト・リトライ設定）
  - パラメータ正規化・検証
  - 多言語エラーハンドリング
  - 実行時間計測・ログ出力

- **OUTPUT：**
  - OpenAI Responseオブジェクト
  - Chat Completionオブジェクト
  - 多言語ログ出力（実行時間・エラー等）

---

## 関数の詳細設計書

### 1. safe_json_serializer()

#### 処理概要
OpenAI APIのレスポンスオブジェクト、Pydanticモデル、datetimeオブジェクトなど、標準のJSONシリアライザーでは処理できないオブジェクトを安全に変換します。

#### 処理の流れ
1. Pydanticモデルの`model_dump()`メソッド試行
2. `dict()`メソッドの試行
3. datetimeオブジェクトのISO形式変換
4. ResponseUsageオブジェクトの手動属性抽出
5. フォールバック：文字列化

#### IPO（INPUT、PROCESS、OUTPUT）
- **INPUT：** Any型オブジェクト（OpenAI APIオブジェクト、Pydantic、datetime等）
- **PROCESS：** 型判定・適切な変換方法選択・エラー耐性
- **OUTPUT：** JSON serializable オブジェクト

---

### 2. get_default_messages()

#### 処理概要
設定ファイル（config.yaml）からカスタマイズ可能なデフォルトプロンプトセットを提供する関数。開発者向けの専門的なプロンプトテンプレートを含みます。

#### 処理の流れ
1. 設定ファイルのdefault_messagesセクション読み込み
2. 各ロール（developer/user/assistant）のプロンプト取得
3. EasyInputMessageParamオブジェクト作成
4. フォールバック：ハードコードされたデフォルト値

#### IPO（INPUT、PROCESS、OUTPUT）
- **INPUT：** 設定ファイルのdefault_messagesセクション
- **PROCESS：** 設定読み込み・プロンプトテンプレート処理・フォールバック
- **OUTPUT：** EasyInputMessageParamのリスト（カスタマイズ可能）

---

### 3. append_user_message()

#### 処理概要
設定ファイルベースのデフォルトメッセージセットにユーザーメッセージを追加した新しいメッセージセットを生成します。画像URL対応も含みます。

#### 処理の流れ
1. 設定ファイルベースのデフォルトメッセージセット取得
2. 新しいユーザーメッセージの追加
3. 画像URL処理（オプション）
4. 完全なメッセージセットの返却

#### IPO（INPUT、PROCESS、OUTPUT）
- **INPUT：** 追加テキスト、画像URL（オプション）、設定ファイルのデフォルトメッセージ
- **PROCESS：** メッセージセット複製・追加・画像処理
- **OUTPUT：** 拡張されたメッセージセット

---

## ユーティリティ関数詳細

### sanitize_key()
キー名を英数字とアンダースコアのみに正規化し、小文字に変換します。設定ファイルのキー処理で使用。

### load_json_file() / save_json_file()
例外処理・ログ出力付きのJSON読み書き関数。save_json_file()は設定ファイルのpathsセクションに基づいてディレクトリを自動作成します。

### format_timestamp()
Unix タイムスタンプ、文字列、Noneを受け取り、人間が読みやすい形式（YYYY-MM-DD HH:MM:SS）に変換します。

### create_session_id()
現在時刻とオブジェクトIDを組み合わせたMD5ハッシュの8文字ユニークセッションIDを生成します。

---

## デコレータ詳細

### @error_handler
関数の例外をキャッチし、設定ファイルの多言語エラーメッセージを使用してログ出力後、例外を再発生させます。API関数用の設計です。

### @timer
関数の実行時間を計測し、設定ファイルのログ設定に従ってログ出力します。パフォーマンス監視用です。

### @cache_result(ttl)
関数の結果を設定ファイルのキャッシュ設定に従ってメモリキャッシュに保存します。引数のMD5ハッシュ値をキーとして使用します。

---

## 設定ファイル詳細（config.yaml）

### 主要設定セクション

#### models（モデル設定）
- **default**: "gpt-4o-mini"（デフォルトモデル）
- **available**: 18モデルリスト
- **categories**: 推論・標準・音声・画像カテゴリ別分類

#### model_pricing（料金設定）
全18モデルの入力・出力別料金（1000トークンあたりUSD）

#### api（API設定）
- **timeout**: 30秒
- **max_retries**: 3回
- **retry_delay**: 1秒
- **max_tokens**: 4096
- **message_limit**: 50（メッセージ履歴上限）

#### error_messages（多言語エラーメッセージ）
日本語・英語対応、10種類のエラーメッセージテンプレート

#### cache（キャッシュ設定）
- **api_responses**: TTL 30分、最大50エントリ
- **model_info**: TTL 24時間、最大20エントリ
- **user_preferences**: TTL 1週間、最大30エントリ

#### paths（パス設定）
データ、ログ、キャッシュ、設定、一時ファイル用ディレクトリ設定

---

## グローバル変数・推奨使用パターン

### グローバル変数
- `config`: ConfigManagerのシングルトンインスタンス（18セクション設定管理）
- `logger`: 多言語対応の設定済みロガーインスタンス
- `cache`: MemoryCacheのインスタンス（多層キャッシュ）

### 推奨使用パターン
```python
# 1. ライブラリインポート
from helper_api import OpenAIClient, MessageManager, ResponseProcessor, TokenManager

# 2. クライアント初期化（APIキー自動取得）
client = OpenAIClient()

# 3. メッセージ管理（設定ファイルベース）
msg_manager = MessageManager()
msg_manager.add_message("user", "質問内容")

# 4. トークン数・コスト事前計算
messages = msg_manager.get_messages()
input_tokens = TokenManager.count_tokens(str(messages), "gpt-4o-mini")
estimated_cost = TokenManager.estimate_cost(input_tokens, 1000, "gpt-4o-mini")

# 5. API呼び出し
response = client.create_response(input=messages, model="gpt-4o-mini")

# 6. レスポンス処理・保存
texts = ResponseProcessor.extract_text(response)
saved_path = ResponseProcessor.save_response(response)
```

### 注意事項
- APIキーは環境変数（OPENAI_API_KEY）または設定ファイルで設定が必要
- 18モデル全対応、料金計算は設定ファイルベース
- キャッシュ機能は多層・タイプ別TTL設定
- エラーメッセージは多言語対応（日本語・英語）
- ログファイルは設定で有効化する必要がある
- 最新のGPTモデル（o1-o4系）にも完全対応

### 設定カスタマイズ
config.yamlの各セクションを編集することで：
- デフォルトプロンプトのカスタマイズ
- 料金設定の更新
- キャッシュ戦略の変更
- ログレベル・出力先の設定
- エラーメッセージの多言語対応
- 新モデル追加への対応

が可能です。
