# a30_011_make_rag_data_customer.py 設計書

## 1. 概要書

### 1.1 処理の概要

カスタマーサポートFAQデータのCSVファイルを読み込み、RAG（Retrieval-Augmented Generation）用に最適化された前処理を行うStreamlitアプリケーション。helper_rag.pyの共通機能を活用し、カスタマーサポート特有のデータ分析・検証機能を追加したWebアプリケーション。

**主要機能:**

- CSVファイルのアップロード・読み込み
- カスタマーサポート特有のデータ品質検証
- テキストクレンジング・正規化処理
- 複数列結合によるRAG用テキスト生成
- OpenAIモデル選択とトークン使用量推定
- 処理済みデータのダウンロード・保存

**技術スタック:**

- フレームワーク: Streamlit
- データ処理: pandas
- 共通機能: helper_rag.py

### 1.2 mainの処理の流れ

初期設定・ページ構築
├─ データセットタイプ設定（customer_support_faq）
├─ setup_page_config() - ページ設定
├─ setup_page_header() - ヘッダー設定
└─ setup_sidebar_header() - サイドバー設定

サイドバー構築
├─ select_model() - OpenAIモデル選択UI
├─ show_model_info() - モデル情報表示
├─ 前処理設定UI（結合オプション、検証表示）
└─ カスタマーサポート特有設定UI

メインエリア構築
├─ 選択モデル情報表示
└─ ファイルアップロードUI

ファイル処理フロー
├─ ファイル存在判定
├─ セッション状態管理
├─ load_dataset() - ファイル読み込み・基本検証
├─ データプレビュー表示
└─ データ検証結果表示
├─ validate_data() - 基本検証（共通機能）
└─ validate_customer_support_data_specific() - 特有検証

前処理実行フロー
├─ 処理ボタン押下判定
├─ process_rag_data() - RAG前処理実行
├─ display_statistics() - 統計情報表示
├─ estimate_token_usage() - トークン使用量推定
└─ カスタマーサポート特有分析

出力処理フロー
├─ create_download_data() - ダウンロード用データ作成
├─ ブラウザダウンロード機能
└─ save_files_to_output() - ローカル保存

補助機能
├─ show_usage_instructions() - 使用方法説明
├─ サンプルデータ表示
└─ デバッグ情報表示


エラーハンドリング
├─ 各段階での例外処理
├─ エラー詳細表示
└─ ファイル診断情報表示

## 2. 関数一覧

### 2.1 アプリケーション固有関数


| 関数名                                      | 処理概要                                    |
| ------------------------------------------- | ------------------------------------------- |
| `validate_customer_support_data_specific()` | カスタマーサポートFAQ特有のデータ検証・分析 |
| `main()`                                    | Streamlitアプリケーションのメイン処理統括   |

### 2.2 helper_rag.py インポート関数


| 関数名                      | 処理概要                      |
| --------------------------- | ----------------------------- |
| `setup_page_config()`       | Streamlitページ設定初期化     |
| `setup_page_header()`       | ページヘッダー設定            |
| `setup_sidebar_header()`    | サイドバーヘッダー設定        |
| `select_model()`            | OpenAIモデル選択UI            |
| `show_model_info()`         | 選択モデル詳細情報表示        |
| `load_dataset()`            | CSVファイル読み込み・基本検証 |
| `validate_data()`           | 汎用データ品質検証            |
| `process_rag_data()`        | RAG用データ前処理実行         |
| `display_statistics()`      | 処理前後統計情報表示          |
| `estimate_token_usage()`    | トークン使用量推定表示        |
| `create_download_data()`    | ダウンロード用データ作成      |
| `save_files_to_output()`    | OUTPUTフォルダへの保存        |
| `show_usage_instructions()` | 使用方法説明表示              |

### 2.3 設定・管理クラス（インポート）


| クラス名       | 処理概要                         |
| -------------- | -------------------------------- |
| `AppConfig`    | OpenAIモデル設定・料金・制限管理 |
| `RAGConfig`    | データセット設定管理             |
| `TokenManager` | トークン数・コスト計算管理       |

## 3. 関数の詳細設計書

### 3.1 validate_customer_support_data_specific()

**処理概要:**
カスタマーサポートFAQデータに特化した品質検証・分析を実行し、サポート関連用語の分析、回答品質評価、質問タイプ分析を行う。

**処理の流れ:**

サポート関連用語の存在確認
├─ キーワードリスト定義（日本語・英語）
├─ question列の存在確認
├─ 各行でのキーワード検索（大文字小文字無視）
├─ 該当件数カウント
└─ 含有率計算・結果記録

回答の長さ品質分析
├─ answer列の存在確認
├─ 各回答の文字数計算
├─ 平均回答長計算
├─ 品質判定（50文字基準）
└─ 適切性評価結果記録


質問の種類分析
├─ 疑問詞・疑問表現リスト定義
├─ question列での疑問表現検索
├─ 疑問形質問カウント
├─ 疑問形比率計算
└─ 結果記録
分析結果リスト生成・返却

**IPO:**

- **INPUT:** `df` (pandas.DataFrame) - カスタマーサポートFAQデータフレーム
- **PROCESS:**
  - サポート用語分析（'問題', '解決', 'トラブル', 'エラー', 'サポート', 'ヘルプ', '対応', 'problem', 'issue', 'error', 'help', 'support', 'solution', 'troubleshoot'）
  - 回答長品質評価（50文字閾値）
  - 疑問形質問分析（'どうすれば', 'なぜ', 'いつ', 'どこで', 'どのように', 'what', 'how', 'why', 'when', 'where'）
- **OUTPUT:** `List[str]` - 分析結果メッセージリスト

### 3.2 main()

**処理概要:**
Streamlitアプリケーション全体の統括制御を行い、UI構築、ファイル処理、データ変換、結果出力、エラーハンドリングまでの一連の処理を管理する。

**処理の流れ:**

初期設定・ページ構築
├─ DATASET_TYPE = "customer_support_faq" 設定
├─ setup_page_config(DATASET_TYPE) 呼び出し
├─ setup_page_header(DATASET_TYPE) 呼び出し
└─ setup_sidebar_header(DATASET_TYPE) 呼び出し

サイドバーUI構築
├─ select_model(key="customer_model_selection") 呼び出し
├─ show_model_info(selected_model) 呼び出し
├─ 前処理設定UI作成
│   ├─ combine_columns_option チェックボックス
│   └─ show_validation チェックボックス
└─ カスタマーサポート特有設定UI作成
├─ preserve_formatting チェックボックス
└─ normalize_questions チェックボックス

メインエリアUI構築
├─ 選択モデル情報表示
└─ st.file_uploader() によるファイルアップロード

ファイル処理制御
├─ アップロードファイル存在判定
├─ ファイル情報表示
├─ セッション状態による重複処理防止
├─ load_dataset() による読み込み・基本検証
├─ セッション状態への保存
└─ データプレビュー表示

データ検証・分析表示
├─ show_validation フラグ判定
├─ 基本検証結果表示（共通機能）
└─ validate_customer_support_data_specific() 実行・表示

前処理実行制御
├─ 処理ボタン押下判定
├─ process_rag_data() による前処理実行
├─ セッション状態への処理済みデータ保存
├─ display_statistics() による統計表示
├─ estimate_token_usage() による推定表示
└─ カスタマーサポート特有分析
├─ サポート用語出現頻度分析
└─ 質問長統計分析

出力処理制御
├─ 処理済みデータ存在確認
├─ create_download_data() によるダウンロード用データ作成
├─ ブラウザダウンロードボタン提供
│   ├─ CSV形式ダウンロード
│   └─ テキスト形式ダウンロード
└─ save_files_to_output() によるローカル保存

補助機能制御
├─ ファイル未選択時のサンプル表示
├─ show_usage_instructions() による使用方法説明
└─ デバッグ情報表示（条件付き）


エラーハンドリング
├─ 各処理段階での try-except
├─ エラー詳細情報表示
├─ ファイル診断情報表示
└─ ログ出力

**IPO:**

- **INPUT:**
  - Streamlit UI入力（ファイルアップロード、設定値）
  - セッション状態データ
  - 環境設定
- **PROCESS:**
  - UI制御・レンダリング
  - ファイル処理統括
  - データ変換・分析統括
  - セッション状態管理
  - エラーハンドリング
- **OUTPUT:**
  - Streamlit UI表示・更新
  - 処理済みファイル出力
  - セッション状態更新
  - ログ出力

## 4. 不足情報の指摘

### 4.1 技術仕様の不足

1. **Streamlit固有の制約**

   - セッション状態の容量制限
   - ファイルアップロードのサイズ制限
   - 同時接続ユーザー数制限
   - セッション有効期限
2. **UIレスポンシブ対応**

   - モバイル端末での表示対応
   - 画面サイズ別レイアウト調整
   - ブラウザ別動作確認
3. **パフォーマンス要件**

   - 大容量CSVファイル処理時の応答時間
   - メモリ使用量制限
   - UI操作の応答性要件

### 4.2 データ処理仕様の不足

1. **カスタマーサポート特有の検証詳細**

   - validate_customer_support_data_specific()の検証基準詳細
   - 回答品質の50文字閾値の根拠
   - サポート用語の追加・カスタマイズ仕様
   - 多言語対応の範囲
2. **データ品質基準**

   - 許容される不正データの割合
   - データ品質スコアの算出方法
   - 品質不良時の処理継続判定基準

### 4.3 セキュリティ・プライバシー仕様の不足

1. **データ保護**

   - アップロードファイルの一時保存期間
   - 個人情報検出・保護機能
   - データ削除の確実性
   - セッション間でのデータ分離
2. **アクセス制御**

   - ユーザー認証の有無
   - アクセスログの取得
   - 不正アクセス対策

### 4.4 運用・保守仕様の不足

1. **ログ・監視**

   - アプリケーションログの出力レベル
   - エラー通知の仕組み
   - 利用統計の収集方法
   - パフォーマンス監視項目
2. **設定管理**

   - 外部設定ファイルの利用
   - 環境別設定の切り替え
   - 設定値の動的変更対応

### 4.5 ユーザビリティ仕様の不足

1. **UI/UX詳細**

   - エラーメッセージの多言語対応
   - 進捗表示の詳細度
   - ヘルプ・ツールチップの内容
   - キーボードショートカット対応
2. **アクセシビリティ**

   - スクリーンリーダー対応
   - 色覚異常者への配慮
   - キーボードナビゲーション対応

### 4.6 テスト仕様の不足

1. **テストケース設計**

   - 単体テストの範囲・方法
   - 統合テストシナリオ
   - ユーザビリティテスト計画
   - 負荷テスト条件
2. **品質保証**

   - コードレビュー基準
   - 品質メトリクス定義
   - 継続的インテグレーション設定
