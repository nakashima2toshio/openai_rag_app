# helper_rag.py 設計書

## 1. 概要書

### 1.1 処理の概要
RAGデータ前処理アプリケーション群で共通利用されるヘルパーモジュール。4種類のデータセット（カスタマーサポートFAQ、医療QA、科学・技術QA、法律・判例QA）に対応した統一的な前処理機能を提供する。

**主要機能:**
- OpenAIモデル設定・料金管理
- データセット設定の統一管理
- UI関数群（モデル選択、情報表示）
- データ処理関数群（クレンジング、検証、変換）
- ファイル保存・ダウンロード機能
- ページ設定・レイアウト機能

### 1.2 mainの処理の流れ
※ helper_rag.pyはライブラリモジュールのため、main関数は存在しない

**モジュール利用の流れ:**

インポート
├─ 各RAGアプリからの関数インポート
└─ 設定クラスの利用
初期設定
├─ setup_page_config() でページ設定
├─ setup_page_header() でヘッダー設定
└─ setup_sidebar_header() でサイドバー設定
UI構築
├─ select_model() でモデル選択
└─ show_model_info() でモデル情報表示
データ処理
├─ load_dataset() でファイル読み込み
├─ validate_data() でデータ検証
├─ process_rag_data() で前処理実行
└─ display_statistics() で統計表示
出力処理
├─ create_download_data() でダウンロード用データ作成
├─ save_files_to_output() でファイル保存
└─ show_usage_instructions() で使用方法表示


## 2. 関数一覧

### 2.1 設定管理クラス

| クラス/メソッド名 | 処理概要 |
|------------------|----------|
| `AppConfig` | OpenAIモデルの設定・料金・制限を管理 |
| `AppConfig.get_model_limits()` | 指定モデルの制限情報取得 |
| `AppConfig.get_model_pricing()` | 指定モデルの料金情報取得 |
| `RAGConfig` | データセット設定の統一管理 |
| `RAGConfig.get_config()` | データセット設定取得 |
| `RAGConfig.get_all_datasets()` | 全データセットタイプ取得 |
| `RAGConfig.get_dataset_by_port()` | ポート番号からデータセット特定 |
| `TokenManager` | トークン数・コスト計算管理 |
| `TokenManager.count_tokens()` | テキストのトークン数推定 |
| `TokenManager.estimate_cost()` | API使用コスト推定 |

### 2.2 デコレータ・ユーティリティ

| 関数名 | 処理概要 |
|--------|----------|
| `safe_execute()` | 関数実行の安全化デコレータ |

### 2.3 UI関数群

| 関数名 | 処理概要 |
|--------|----------|
| `select_model()` | OpenAIモデル選択UI |
| `show_model_info()` | 選択モデルの詳細情報表示 |
| `estimate_token_usage()` | 処理済みデータのトークン使用量推定表示 |

### 2.4 データ処理関数群

| 関数名 | 処理概要 |
|--------|----------|
| `clean_text()` | テキストクレンジング処理 |
| `combine_columns()` | 複数列の結合処理（データセット対応） |
| `validate_data()` | データ品質検証 |
| `load_dataset()` | CSVファイル読み込み・基本検証 |
| `process_rag_data()` | RAG用データ前処理実行 |
| `create_download_data()` | ダウンロード用データ作成 |
| `display_statistics()` | 処理前後統計情報表示 |

### 2.5 ファイル保存関数群

| 関数名 | 処理概要 |
|--------|----------|
| `create_output_directory()` | OUTPUTディレクトリ作成・権限確認 |
| `save_files_to_output()` | 処理済みデータのファイル保存 |

### 2.6 ページ設定関数群

| 関数名 | 処理概要 |
|--------|----------|
| `show_usage_instructions()` | データセット別使用方法説明表示 |
| `setup_page_config()` | Streamlitページ設定初期化 |
| `setup_page_header()` | ページヘッダー設定 |
| `setup_sidebar_header()` | サイドバーヘッダー設定 |

## 3. 関数の詳細設計書

### 3.1 AppConfig.get_model_limits()

**処理概要:**
指定されたOpenAIモデルの制限情報（最大トークン数、最大出力トークン数）を取得する。

**処理の流れ:**

- モデル名をキーとしてMODEL_LIMITS辞書を検索
- 該当モデルの制限情報を取得
- 存在しない場合はデフォルト値を返却


**IPO:**
- **INPUT:** `model` (str) - モデル名
- **PROCESS:** 辞書検索・デフォルト値設定
- **OUTPUT:** `Dict[str, int]` - {"max_tokens": int, "max_output": int}

### 3.2 clean_text()

**処理概要:**
テキストデータのクレンジング処理を実行し、RAG用に最適化されたテキストに変換する。

**処理の流れ:**

- 入力値検証（None・空文字チェック）
- 文字列型への変換
- 改行文字の空白への置換
- 連続空白の正規化
- 先頭・末尾空白の除去
- 引用符の正規化
- クレンジング済みテキストの返却


**IPO:**
- **INPUT:** `text` (str) - クレンジング対象テキスト
- **PROCESS:** 改行・空白・引用符の正規化
- **OUTPUT:** `str` - クレンジング済みテキスト

### 3.3 combine_columns()

**処理概要:**
データセットタイプに応じて複数列を結合し、RAG用の統合テキストを生成する。

**処理の流れ:**

データセット設定の取得
必須列リストの取得
各列データの抽出・クレンジング
医療QA特別処理（大文字小文字対応）
├─ 列名マッピング作成
├─ question, complex_cot, response の識別
└─ 医療QA用結合処理
標準結合処理
結合テキストの返却


**IPO:**
- **INPUT:**
  - `row` (pd.Series) - 行データ
  - `dataset_type` (str) - データセットタイプ
- **PROCESS:** データセット対応列結合、特別処理適用
- **OUTPUT:** `str` - 結合済みテキスト

### 3.4 load_dataset()

**処理概要:**
アップロードされたCSVファイルを読み込み、基本的なデータ検証を実行する。

**処理の流れ:**

CSVファイル読み込み（pandas）
validate_data()による基本検証実行
読み込み結果のログ出力
データフレームと検証結果の返却


**IPO:**
- **INPUT:**
  - `uploaded_file` - Streamlitアップロードファイル
  - `dataset_type` (str, optional) - データセットタイプ
- **PROCESS:** CSV読み込み、データ検証実行
- **OUTPUT:** `Tuple[pd.DataFrame, List[str]]` - (データフレーム, 検証結果)

### 3.5 process_rag_data()

**処理概要:**
RAG用データの包括的前処理を実行し、クレンジング・正規化・結合を行う。

**処理の流れ:**

データフレームコピー作成
重複行除去
├─ drop_duplicates()実行
└─ 除去件数カウント
空行除去
├─ dropna(how='all')実行
└─ 除去件数カウント
インデックスリセット
各列のクレンジング
├─ 必須列リスト取得
├─ 大文字小文字対応列名マッチング
└─ clean_text()適用
列結合処理（オプション）
├─ combine_columns()実行
├─ Combined_Text列作成
└─ 空結合テキスト除去
処理済みデータ返却


**IPO:**
- **INPUT:**
  - `df` (pd.DataFrame) - 処理対象データフレーム
  - `dataset_type` (str) - データセットタイプ
  - `combine_columns_option` (bool) - 列結合オプション
- **PROCESS:** 重複・空行除去、クレンジング、列結合
- **OUTPUT:** `pd.DataFrame` - 前処理済みデータフレーム

### 3.6 save_files_to_output()

**処理概要:**
処理済みデータをOUTPUTフォルダに複数形式で保存し、メタデータも生成する。

**処理の流れ:**

OUTPUTディレクトリ作成・確認
タイムスタンプ生成
CSVファイル保存
├─ ファイル名生成（dataset_type, 行数, timestamp）
├─ UTF-8エンコーディングで保存
└─ 保存成功確認
テキストファイル保存（条件付き）
├─ text_dataの存在確認
├─ dataset_type.txt形式で保存
└─ 保存成功確認
メタデータファイル保存
├─ 処理情報の辞書作成
├─ JSON形式で保存
└─ 保存成功確認
保存ファイル情報返却


**IPO:**
- **INPUT:**
  - `df_processed` - 処理済みデータフレーム
  - `dataset_type` (str) - データセットタイプ
  - `csv_data` (str) - CSVデータ
  - `text_data` (str, optional) - テキストデータ
- **PROCESS:** ディレクトリ作成、ファイル保存、メタデータ生成
- **OUTPUT:** `Dict[str, str]` - 保存ファイルパス辞書

### 3.7 setup_page_config()

**処理概要:**
データセットタイプに応じたStreamlitページ設定の初期化を行う。

**処理の流れ:**

データセット設定の取得
st.set_page_config()実行
├─ page_title設定（データセット名+前処理）
├─ page_icon設定（データセット固有アイコン）
├─ layout="wide"設定
└─ initial_sidebar_state="expanded"設定
例外処理（既に設定済みの場合をハンドリング）


**IPO:**
- **INPUT:** `dataset_type` (str) - データセットタイプ
- **PROCESS:** 設定取得、Streamlitページ設定適用
- **OUTPUT:** None (副作用: Streamlitページ設定変更)

## 4. 不足情報の指摘

### 4.1 技術仕様の不足

1. **パフォーマンス仕様**
   - 各関数の処理時間制限
   - メモリ使用量上限
   - 最大処理可能データサイズ
   - 大容量ファイル処理時の分割処理仕様

2. **トークン推定精度**
   - count_tokens()の推定精度に関する仕様
   - 実際のOpenAI APIとの誤差許容範囲
   - モデル別の推定ロジック調整要否

3. **ファイル形式詳細**
   - 対応CSVエンコーディング一覧
   - 区切り文字の対応範囲
   - ファイルサイズ制限
   - 不正ファイル検出仕様

### 4.2 エラーハンドリング仕様の不足

1. **safe_execute デコレータ**
   - エラー分類・レベル別処理
   - リトライ機能の有無
   - エラー通知方法
   - ログ出力レベル制御

2. **ファイル保存エラー**
   - ディスク容量不足時の処理
   - 権限エラー時の代替手段
   - ファイル名重複時の処理
   - 部分保存失敗時のロールバック

### 4.3 データ品質管理仕様の不足

1. **データ検証詳細**
   - validate_data()の検証項目詳細化
   - データセット特有の検証ルール
   - 警告レベルと処理継続判定
   - データ品質スコア算出

2. **クレンジング処理詳細**
   - clean_text()の処理対象文字種
   - 保護すべき特殊文字の定義
   - 多言語対応範囲
   - カスタムクレンジングルール対応

### 4.4 設定管理仕様の不足

1. **外部設定ファイル**
   - 設定ファイルの形式・場所
   - 環境別設定の切り替え方法
   - 動的設定変更の対応
   - 設定値検証機能

2. **ログ設定**
   - ログレベル設定の詳細
   - ログファイルローテーション
   - ログフォーマット標準化
   - デバッグモード対応

### 4.5 セキュリティ・運用仕様の不足

1. **セキュリティ要件**
   - アップロードファイルのスキャン
   - パストラバーサル対策
   - 一時ファイルの安全な削除
   - 個人情報検出・保護

2. **運用・監視要件**
   - ヘルスチェック機能
   - メトリクス収集項目
   - アラート条件定義
   - バックアップ・リストア手順再試行Claudeは間違えることがあります。回答内容を必ずご確認ください。